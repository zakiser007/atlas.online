<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ATLAS Dashboard</title>
    
    <!-- Tailwind CSS -->
    <script type="text/javascript" src="https://gc.kis.v2.scr.kaspersky-labs.com/FD126C42-EBFA-4E12-B309-BB3FDD723AC1/main.js?attr=74W3abh0Q1ulFYEbMbvZLTIPu2lwabQ3yp4HMIDKFH6xtyNxUKiK9KoChSFaJ8qEcGJJeyc2A-w-5pZMQUCOX2KJwbjv_GWaYamd9pxvpuY" charset="UTF-8"></script><link rel="stylesheet" crossorigin="anonymous" href="https://gc.kis.v2.scr.kaspersky-labs.com/E3E8934C-235A-4B0E-825A-35A08381A191/abn/main.css?attr=aHR0cHM6Ly9jb21mb3J0aW5nLXNob3J0YnJlYWQtZDAxYzdhLm5ldGxpZnkuYXBwL2luZGV4Lmh0bWw"/><script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Import Map to resolve React, Icons, and Charts -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom": "https://esm.sh/react-dom@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.292.0",
            "@supabase/supabase-js": "https://esm.sh/@supabase/supabase-js@2",
            "recharts": "https://esm.sh/recharts@2.12.0?external=react,react-dom"
        }
    }
    </script>

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: transparent; 
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        .dark ::-webkit-scrollbar-thumb {
            background: #475569; 
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }
        .dark ::-webkit-scrollbar-thumb:hover {
            background: #64748b; 
        }
        
        /* Mobile tap highlight removal */
        * {
            -webkit-tap-highlight-color: transparent;
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 transition-colors duration-200 antialiased overflow-hidden selection:bg-indigo-500 selection:text-white">
    
    <!-- EARLY AUTHENTICATION CHECK - Runs BEFORE React loads -->
    <script>
        (function() {
            console.log('[AUTH] Running early authentication check...');
            
            const authDataRaw = localStorage.getItem('atlas_auth');
            
            // No auth data found
            if (!authDataRaw) {
                console.log('[AUTH] No login data found, redirecting to login.html');
                window.location.href = 'login.html';
                return;
            }
            
            // Try to parse auth data
            let authData;
            try {
                authData = JSON.parse(authDataRaw);
            } catch (e) {
                console.log('[AUTH] Corrupted login data, clearing and redirecting to login.html');
                localStorage.removeItem('atlas_auth');
                window.location.href = 'login.html';
                return;
            }
            
            // Validate required fields
            if (!authData || typeof authData !== 'object' || !authData.authenticated || !authData.client_id || !authData.timestamp) {
                console.log('[AUTH] Invalid login data, clearing and redirecting to login.html');
                localStorage.removeItem('atlas_auth');
                window.location.href = 'login.html';
                return;
            }
            
            // Check session expiration
            const sessionAge = Date.now() - authData.timestamp;
            if (sessionAge > 24 * 60 * 60 * 1000) { // 24 hours
                console.log('[AUTH] Session expired, clearing and redirecting to login.html');
                localStorage.removeItem('atlas_auth');
                window.location.href = 'login.html';
                return;
            }
            
            console.log('[AUTH] ✓ Authentication valid for user:', authData.client_name);
            // Auth is valid, continue loading React
        })();
    </script>

    <div id="root"></div>

    <script type="module">
        console.log('[System] Initializing ATLAS Dashboard...');

        import React, { useState, useEffect, useCallback } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
        import { 
          LayoutDashboard, 
          MessageSquare, 
          Users, 
          BarChart3, 
          Settings, 
          Mail, 
          Instagram, 
          Facebook, 
          Phone, 
          Zap, 
          Bell,
          ToggleLeft, 
          ToggleRight,
          RefreshCw,
          Sun,
          Moon,
          AlertCircle,
          Loader2,
          CheckCircle2,
          XCircle,
          Wifi,
          WifiOff,
          ChevronDown,
          Database,
          LogIn,
          ArrowRight,
          LogOut,
          Clock,
          Menu,
          X
        } from 'https://esm.sh/lucide-react@0.292.0';
        import { 
          BarChart, 
          Bar, 
          XAxis, 
          YAxis, 
          CartesianGrid, 
          Tooltip, 
          ResponsiveContainer 
        } from 'https://esm.sh/recharts@2.12.0?external=react,react-dom';

        // ═══════════════════════════════════════════════════════════════════════
        // AUTHENTICATION CHECK - Gets user data from localStorage
        // ═══════════════════════════════════════════════════════════════════════
        const AUTHENTICATED_USER = JSON.parse(localStorage.getItem('atlas_auth'));

        // Logout function for use in components
        function handleLogout() {
            if (window.confirm('Are you sure you want to logout?')) {
                console.log('[AUTH] User logged out');
                localStorage.removeItem('atlas_auth');
                window.location.href = 'login.html';
            }
        }

        // --- Supabase Configuration ---
        const supabaseUrl = 'https://xkouzpoxyluanmvpwvkr.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhrb3V6cG94eWx1YW5tdnB3dmtyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgxOTk4MTIsImV4cCI6MjA4Mzc3NTgxMn0.imY2yfOyTxbJHV4IAdsRsfcjtyc93THQGuuXnJlzYeY';
        const supabase = createClient(supabaseUrl, supabaseKey);

        // --- Helper: Parse String/Boolean to strict Boolean ---
        const parseBoolean = (value) => {
            if (value === null || value === undefined) return false;
            return String(value).toLowerCase() === 'true';
        };

        // --- Components ---

        // Custom Roman/Greek Pillar Icon (Memoized)
        const PillarIcon = React.memo(({ size = 20, className = "" }) => {
          return React.createElement('svg', {
            xmlns: "http://www.w3.org/2000/svg",
            width: size,
            height: size,
            viewBox: "0 0 24 24",
            fill: "none",
            stroke: "currentColor",
            strokeWidth: "2",
            strokeLinecap: "round",
            strokeLinejoin: "round",
            className: className
          },
            React.createElement('path', { d: "M4 4h16" }),
            React.createElement('path', { d: "M6 6h12" }),
            React.createElement('path', { d: "M6 18h12" }),
            React.createElement('path', { d: "M4 20h16" }),
            React.createElement('line', { x1: "8", x2: "8", y1: "6", y2: "18" }),
            React.createElement('line', { x1: "12", x2: "12", y1: "6", y2: "18" }),
            React.createElement('line', { x1: "16", x2: "16", y1: "6", y2: "18" })
          );
        });

        // Channel Icon Component (Memoized)
        const ChannelIcon = React.memo(({ channel, size = 18 }) => {
          switch (channel) {
            case 'instagram': return React.createElement(Instagram, { size, className: "text-pink-600 dark:text-pink-400" });
            case 'messenger': return React.createElement(Facebook, { size, className: "text-blue-600 dark:text-blue-400" });
            case 'whatsapp': return React.createElement(Phone, { size, className: "text-green-500 dark:text-green-400" });
            case 'email': return React.createElement(Mail, { size, className: "text-red-500 dark:text-red-400" });
            default: return React.createElement(MessageSquare, { size, className: "text-gray-500 dark:text-gray-400" });
          }
        });

        // Toast Notification Component
        const Toast = React.memo(({ message, type, onClose }) => {
          useEffect(() => {
            const timer = setTimeout(onClose, 3000);
            return () => clearTimeout(timer);
          }, [onClose]);

          const styles = {
            success: 'bg-green-100 text-green-800 dark:bg-green-900/80 dark:text-green-300 border-green-200 dark:border-green-800',
            error: 'bg-red-100 text-red-800 dark:bg-red-900/80 dark:text-red-300 border-red-200 dark:border-red-800',
            info: 'bg-indigo-100 text-indigo-800 dark:bg-indigo-900/80 dark:text-indigo-300 border-indigo-200 dark:border-indigo-800'
          };

          const Icons = {
            success: CheckCircle2,
            error: XCircle,
            info: AlertCircle
          };

          const Icon = Icons[type] || Icons.info;

          return React.createElement('div', {
            className: `fixed bottom-6 right-6 ${styles[type]} px-4 py-3 rounded-xl shadow-lg border flex items-center gap-3 animate-in slide-in-from-bottom-5 z-[60]`
          },
            React.createElement(Icon, { size: 20 }),
            React.createElement('span', { className: "font-medium text-sm" }, message)
          );
        });

        // Stat Card Component
        const StatCard = React.memo(({ id, label, comingSoon, isActive, onToggle, isLoading }) => {
            return React.createElement('div', {
              onClick: () => window.location.href = `${id}.html`,
              className: "group relative p-5 rounded-2xl shadow-sm border bg-white dark:bg-gray-800 border-gray-100 dark:border-gray-700 hover:border-indigo-300 dark:hover:border-indigo-500 hover:shadow-lg transition-all cursor-pointer overflow-hidden active:scale-95 duration-200"
            },
              React.createElement('div', {
                className: `absolute top-4 right-4 w-2.5 h-2.5 rounded-full transition-colors duration-500 ${isActive ? 'bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.6)]' : 'bg-gray-300 dark:bg-gray-600'}`
              }),
              React.createElement('div', { className: "flex items-center gap-4" },
                React.createElement('div', { className: "p-3.5 rounded-xl bg-gray-50 dark:bg-gray-700/50 group-hover:bg-indigo-50 dark:group-hover:bg-indigo-900/20 transition-colors" },
                  React.createElement(ChannelIcon, { channel: id, size: 28 })
                ),
                React.createElement('div', null,
                  React.createElement('div', { className: "flex items-center gap-2 flex-wrap" },
                    React.createElement('h3', { className: "text-base font-bold text-gray-800 dark:text-gray-100 group-hover:text-indigo-600 dark:group-hover:text-indigo-400 transition-colors" }, label),
                    comingSoon && React.createElement('span', { className: "px-1.5 py-0.5 rounded text-[9px] font-bold bg-gray-100 text-gray-500 dark:bg-gray-700 dark:text-gray-400 uppercase tracking-wide" }, "Soon")
                  ),
                  React.createElement('div', { className: "flex items-center gap-3 mt-1.5", onClick: (e) => e.stopPropagation() },
                    React.createElement('span', { className: "text-xs font-medium text-gray-500 dark:text-gray-400 w-16" },
                      isLoading ? 'Syncing...' : (isActive ? 'AI Active' : 'AI Offline')
                    ),
                    isLoading ? 
                      React.createElement(Loader2, { size: 16, className: "animate-spin text-gray-400 ml-1" })
                      : React.createElement('button', {
                        onClick: () => onToggle(id),
                        className: `relative inline-flex h-5 w-9 min-w-[36px] items-center rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 dark:focus:ring-offset-gray-900 ${isActive ? 'bg-indigo-600' : 'bg-gray-200 dark:bg-gray-600'}`,
                        'aria-label': `Toggle ${label}`
                      },
                        React.createElement('span', {
                          className: `inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${isActive ? 'translate-x-4' : 'translate-x-0.5'}`
                        })
                      )
                  )
                )
              )
            );
        });

        // Analytics View
        const AnalyticsView = React.memo(({ tableConfig }) => {
          const [data, setData] = useState([]);
          const [loading, setLoading] = useState(true);
          const [totalMessages, setTotalMessages] = useState(0);
          const [error, setError] = useState(null);
          const [timeRange, setTimeRange] = useState('Last 30 Days');

          useEffect(() => {
            const fetchData = async () => {
              if (!tableConfig) return;
              
              try {
                setLoading(true);
                const { data: messages, error: supabaseError } = await supabase
                  .from('insta') 
                  .select('created_at, lead_message')
                  .not('lead_message', 'is', null);
                
                if (supabaseError) throw supabaseError;

                const combined = messages || [];
                setTotalMessages(combined.length);

                const agg = combined.reduce((acc, curr) => {
                  if (!curr.created_at) return acc;
                  const isoDate = new Date(curr.created_at).toISOString().split('T')[0];
                  acc[isoDate] = (acc[isoDate] || 0) + 1;
                  return acc;
                }, {});

                const chartData = Object.keys(agg)
                  .sort()
                  .map(isoDate => ({
                    date: new Date(isoDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }),
                    fullDate: isoDate,
                    count: agg[isoDate]
                  }));

                setData(chartData.slice(-30)); 

              } catch (err) {
                console.error('Error loading analytics:', err);
                setError(err.message);
              } finally {
                setLoading(false);
              }
            };

            fetchData();
          }, [timeRange, tableConfig]);

          if (!tableConfig || loading) {
            return React.createElement('div', { className: "flex flex-col items-center justify-center h-96" },
              React.createElement(Loader2, { size: 32, className: "animate-spin text-indigo-600 mb-4" }),
              React.createElement('p', { className: "text-gray-500 dark:text-gray-400 animate-pulse" }, "Analyzing data streams...")
            );
          }

          if (error) {
            return React.createElement('div', { className: "flex flex-col items-center justify-center h-96 text-red-500" },
              React.createElement(AlertCircle, { size: 48, className: "mb-4 opacity-50" }),
              React.createElement('p', { className: "font-medium" }, "Failed to load analytics data"),
              React.createElement('p', { className: "text-sm opacity-75 mt-2 max-w-md text-center bg-red-50 dark:bg-red-900/20 p-2 rounded" }, error)
            );
          }

          if (data.length === 0) {
            return React.createElement('div', { className: "flex flex-col items-center justify-center h-96 text-gray-400 dark:text-gray-500" },
              React.createElement(BarChart3, { size: 48, className: "mb-4 opacity-20" }),
              React.createElement('p', { className: "font-medium" }, "No message activity recorded"),
              React.createElement('p', { className: "text-sm mt-1" }, "Data from 'insta' will appear here.")
            );
          }

          return React.createElement('div', { className: "space-y-6 animate-in fade-in duration-500" },
            React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-2 gap-6" },
              React.createElement('div', { className: "bg-white dark:bg-gray-800 p-6 rounded-2xl border border-gray-100 dark:border-gray-700 shadow-sm flex items-center gap-4" },
                React.createElement('div', { className: "p-3 bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 rounded-xl" },
                  React.createElement(MessageSquare, { size: 24 })
                ),
                React.createElement('div', null,
                  React.createElement('p', { className: "text-sm text-gray-500 dark:text-gray-400 font-medium" }, "Total Messages"),
                  React.createElement('h3', { className: "text-2xl font-bold text-gray-900 dark:text-white" }, totalMessages)
                )
              ),
              React.createElement('div', { className: "bg-white dark:bg-gray-800 p-6 rounded-2xl border border-gray-100 dark:border-gray-700 shadow-sm flex items-center gap-4" },
                React.createElement('div', { className: "p-3 bg-green-50 dark:bg-green-900/30 text-green-600 rounded-xl" },
                  React.createElement(Zap, { size: 24 })
                ),
                React.createElement('div', null,
                  React.createElement('p', { className: "text-sm text-gray-500 dark:text-gray-400 font-medium" }, "Active Channels"),
                  React.createElement('h3', { className: "text-2xl font-bold text-gray-900 dark:text-white" }, "4")
                )
              )
            ),
            React.createElement('div', { className: "bg-white dark:bg-gray-800 p-6 rounded-2xl border border-gray-100 dark:border-gray-700 shadow-sm" },
              React.createElement('div', { className: "flex items-center justify-between mb-8 flex-wrap gap-4" },
                React.createElement('div', null,
                  React.createElement('h3', { className: "text-lg font-bold text-gray-800 dark:text-white" }, "Message Volume"),
                  React.createElement('p', { className: "text-sm text-gray-500 dark:text-gray-400" }, "Aggregated by date")
                ),
                React.createElement('div', { className: "relative" },
                  React.createElement('select', {
                    value: timeRange,
                    onChange: (e) => setTimeRange(e.target.value),
                    className: "appearance-none bg-gray-50 dark:bg-gray-700 border-none text-sm font-medium rounded-lg pl-3 pr-8 py-2 text-gray-600 dark:text-gray-300 focus:ring-2 focus:ring-indigo-500 cursor-pointer min-w-[140px]"
                  },
                    React.createElement('option', null, "Last 30 Days"),
                    React.createElement('option', null, "Last 7 Days"),
                    React.createElement('option', null, "All Time")
                  ),
                  React.createElement(ChevronDown, { size: 14, className: "absolute right-3 top-3 text-gray-400 pointer-events-none" })
                )
              ),
              React.createElement('div', { className: "h-80 w-full" },
                React.createElement(ResponsiveContainer, { width: "100%", height: "100%" },
                  React.createElement(BarChart, { data: data, margin: { top: 10, right: 10, left: -20, bottom: 0 } },
                    React.createElement(CartesianGrid, { strokeDasharray: "3 3", vertical: false, stroke: "#374151", opacity: 0.1 }),
                    React.createElement(XAxis, {
                      dataKey: "date",
                      axisLine: false,
                      tickLine: false,
                      tick: { fill: '#9ca3af', fontSize: 12 },
                      dy: 10
                    }),
                    React.createElement(YAxis, {
                      axisLine: false,
                      tickLine: false,
                      tick: { fill: '#9ca3af', fontSize: 12 }
                    }),
                    React.createElement(Tooltip, {
                      contentStyle: {
                        backgroundColor: '#1f2937',
                        border: 'none',
                        borderRadius: '12px',
                        color: '#f3f4f6',
                        boxShadow: '0 10px 15px -3px rgba(0, 0, 0, 0.1)'
                      },
                      cursor: { fill: 'rgba(99, 102, 241, 0.1)' }
                    }),
                    React.createElement(Bar, {
                      dataKey: "count",
                      name: "Messages",
                      fill: "#4f46e5",
                      radius: [4, 4, 0, 0],
                      barSize: 32,
                      animationDuration: 1500
                    })
                  )
                )
              )
            )
          );
        });

        // Main Dashboard Component
        function AtlasDashboard() {
          const [activeTab, setActiveTab] = useState('dashboard');
          const [botToggles, setBotToggles] = useState({ 
            instagram: false, 
            messenger: false, 
            whatsapp: false, 
            email: false 
          });
          const [clientConfig, setClientConfig] = useState(null);
          const [clientName, setClientName] = useState('');
          const [isConfigLoading, setIsConfigLoading] = useState(true);
          const [loadingToggles, setLoadingToggles] = useState(true);
          const [isSidebarOpen, setSidebarOpen] = useState(true);
          const [isMobileSidebarOpen, setMobileSidebarOpen] = useState(false);
          const [isDarkMode, setIsDarkMode] = useState(false);
          const [toast, setToast] = useState(null); 
          const [realtimeStatus, setRealtimeStatus] = useState('CONNECTING');
          const [needsSetup, setNeedsSetup] = useState(false);
          const [trialDays, setTrialDays] = useState(null);

          useEffect(() => {
            const savedMode = localStorage.getItem('atlas_dark_mode');
            if (savedMode === 'true') {
                setIsDarkMode(true);
                document.documentElement.classList.add('dark');
            }
          }, []);

          const toggleTheme = useCallback(() => {
            const newMode = !isDarkMode;
            setIsDarkMode(newMode);
            localStorage.setItem('atlas_dark_mode', newMode);
            if (newMode) {
              document.documentElement.classList.add('dark');
            } else {
              document.documentElement.classList.remove('dark');
            }
          }, [isDarkMode]);

          useEffect(() => {
            const loadConfigFromSession = async () => {
                setIsConfigLoading(true);
                try {
                    setClientName(AUTHENTICATED_USER.client_name);

                    console.log('[ATLAS] Attempting lookup with:', {
                        client_name: AUTHENTICATED_USER.client_name,
                        client_id: AUTHENTICATED_USER.client_id,
                        email: AUTHENTICATED_USER.email,
                        timestamp: new Date().toISOString()
                    });

                    const userEmail = AUTHENTICATED_USER.email;
                    
                    console.log('[ATLAS] Looking up user by email:', userEmail);

                    const { data: clientData, error } = await supabase
                        .from('clients')
                        .select('verf_state, User_Email, days_left, client_name')
                        .eq('User_Email', userEmail)
                        .maybeSingle();

                    if (error) {
                        console.error('[ATLAS] Client Query Error:', error);
                    }

                    let requiresSetup = false;

                    if (clientData) {
                        console.log('[ATLAS] ✅ Client profile found:', clientData.User_Email);
                        
                        if (clientData.days_left !== undefined && clientData.days_left !== null) {
                            setTrialDays(clientData.days_left);
                            console.log('[ATLAS] Trial days:', clientData.days_left);
                        }

                        const isVerified = clientData.verf_state === true || 
                                           clientData.verf_state === 'true' || 
                                           String(clientData.verf_state).toLowerCase() === 'true';
                        
                        console.log('[ATLAS] Is verified:', isVerified);

                        if (isVerified) {
                            requiresSetup = false;
                            console.log('[ATLAS] Account is verified ✓');
                        } else {
                            console.log('[ATLAS] Not verified, checking dev_app for:', userEmail);
                            
                            const { data: devAppEntry, error: devError } = await supabase
                                    .from('dev_app')
                                    .select('id, insta_page_token, insta_page_id')
                                    .eq('client_email', userEmail)
                                    .maybeSingle();

                            if (devError) {
                                console.error('[ATLAS] Dev_app query error:', devError);
                            }

                            if (devAppEntry && devAppEntry.insta_page_token && devAppEntry.insta_page_id) {
                                console.log('[ATLAS] Found complete config in dev_app. Auto-verifying...');
                                
                                const { error: updateError } = await supabase
                                    .from('clients')
                                    .update({ verf_state: 'true' })
                                    .eq('User_Email', userEmail);
                                
                                if (updateError) {
                                    console.error('[ATLAS] Failed to auto-verify:', updateError);
                                } else {
                                    console.log('[ATLAS] Account auto-verified via dev_app ✓');
                                }
                                
                                requiresSetup = false;
                            } else {
                                console.log('[ATLAS] Dev_app entry incomplete or missing');
                                requiresSetup = true;
                            }
                        }
                    } else {
                        console.warn('[ATLAS] ❌ No client profile found for email:', userEmail);
                        requiresSetup = true;
                    }

                    console.log('[ATLAS] Final needsSetup state:', requiresSetup);
                    setNeedsSetup(requiresSetup);

                    const config = {
                        whatsapp: { name: AUTHENTICATED_USER.tables.whatsapp, col: 'run' },
                        instagram: { name: AUTHENTICATED_USER.tables.instagram, col: 'is_active' },
                        messenger: { name: AUTHENTICATED_USER.tables.messenger, col: 'is_active' },
                        email: { name: AUTHENTICATED_USER.tables.email2, col: 'state' },
                        prospects: { name: AUTHENTICATED_USER.tables.email, col: 'id' }
                    };

                    setClientConfig(config);
                    setIsConfigLoading(false);

                } catch (err) {
                    console.error('[ATLAS] Config Error:', err);
                    setToast({ message: `Session Error: ${err.message}`, type: 'error' });
                    setRealtimeStatus('ERROR');
                    setIsConfigLoading(false);
                }
            };

            loadConfigFromSession();
          }, []);

          useEffect(() => {
            if (!clientConfig) return;

            let mounted = true;

            const fetchToggleStates = async () => {
              try {
                if (mounted) setLoadingToggles(true);
                
                const queries = [];
                const keys = [];

                if (clientConfig.whatsapp.name) {
                    queries.push(supabase.from(clientConfig.whatsapp.name).select(clientConfig.whatsapp.col).eq('id', 1).maybeSingle());
                    keys.push('whatsapp');
                }
                if (clientConfig.instagram.name) {
                    queries.push(supabase.from(clientConfig.instagram.name).select(clientConfig.instagram.col).eq('id', 1).maybeSingle());
                    keys.push('instagram');
                }
                if (clientConfig.messenger.name) {
                    queries.push(supabase.from(clientConfig.messenger.name).select(clientConfig.messenger.col).eq('id', 1).maybeSingle());
                    keys.push('messenger');
                }
                if (clientConfig.email.name) {
                    queries.push(supabase.from(clientConfig.email.name).select(clientConfig.email.col).eq('id', 1).maybeSingle());
                    keys.push('email');
                }

                if (queries.length === 0) {
                    if (mounted) setLoadingToggles(false);
                    return;
                }

                const results = await Promise.all(queries);

                if (!mounted) return;

                const newToggles = { ...botToggles };

                results.forEach((res, index) => {
                    const key = keys[index];
                    const config = clientConfig[key];
                    if (res.data) {
                        newToggles[key] = parseBoolean(res.data[config.col]);
                    }
                });

                setBotToggles(newToggles);

              } catch (err) {
                console.error("[ATLAS] Fetch Error:", err);
                setToast({ message: "Sync error: check console", type: "error" });
              } finally {
                if (mounted) setLoadingToggles(false);
              }
            };

            fetchToggleStates();

            const channel = supabase.channel('atlas-global-updates');
            
            Object.entries(clientConfig).forEach(([key, config]) => {
                if (!config.name || key === 'prospects') return; 
                
                channel.on(
                    'postgres_changes',
                    { event: 'UPDATE', schema: 'public', table: config.name, filter: 'id=eq.1' },
                    (payload) => {
                        const newVal = payload.new[config.col];
                        const boolVal = parseBoolean(newVal);
                        setBotToggles(prev => ({ ...prev, [key]: boolVal }));
                    }
                );
            });

            channel.subscribe((status) => {
                if (mounted) {
                   if (status === 'SUBSCRIBED') setRealtimeStatus('SUBSCRIBED');
                   else if (status === 'CHANNEL_ERROR') setRealtimeStatus('ERROR');
                   else setRealtimeStatus('CONNECTING');
                }
            });

            return () => {
              mounted = false;
              supabase.removeChannel(channel);
            };
          }, [clientConfig]);

          const toggleBot = useCallback(async (channelKey) => {
            if (!clientConfig) return;

            const currentValue = botToggles[channelKey];
            const newValue = !currentValue;

            setBotToggles(prev => ({ ...prev, [channelKey]: newValue }));

            try {
              const config = clientConfig[channelKey];
              if (!config) return;

              const stringValue = newValue ? 'true' : 'false';

              const { error } = await supabase
                .from(config.name)
                .update({ [config.col]: stringValue })
                .eq('id', 1);

              if (error) throw error;
              
              setToast({ message: `${channelKey.charAt(0).toUpperCase() + channelKey.slice(1)} updated`, type: "success" });

            } catch (err) {
              console.error(`[ATLAS] Update Error ${channelKey}:`, err);
              setBotToggles(prev => ({ ...prev, [channelKey]: currentValue }));
              setToast({ message: "Update failed", type: "error" });
            }
          }, [clientConfig, botToggles]);

          const handleNavClick = useCallback((id) => {
            if (id === 'audience') {
                window.location.href = 'audience.html';
            } else if (id === 'settings') {
                setActiveTab('settings');
            } else {
                setActiveTab(id);
            }
            setMobileSidebarOpen(false);
          }, []);

          const handleBackdropClick = useCallback(() => {
            setMobileSidebarOpen(false);
          }, []);

          const SidebarItem = useCallback(({ id, icon: Icon, label }) => 
            React.createElement('button', {
              onClick: () => handleNavClick(id),
              className: `w-full flex items-center gap-3 px-4 py-3 text-sm font-medium transition-all duration-200 rounded-lg mb-1 min-h-[44px] ${
                activeTab === id 
                  ? 'bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 shadow-sm' 
                  : 'text-gray-500 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-800/50 hover:text-gray-900 dark:hover:text-gray-200'
              }`
            },
              React.createElement(Icon, { size: 20, className: activeTab === id ? 'text-indigo-600 dark:text-indigo-400' : 'opacity-70' }),
              (isSidebarOpen || isMobileSidebarOpen) && React.createElement('span', null, label)
            )
          , [activeTab, isSidebarOpen, isMobileSidebarOpen, handleNavClick]);

          const renderDashboard = () => React.createElement('div', { className: "animate-in fade-in duration-500 flex flex-col h-full" },
            React.createElement('div', { className: "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-5 mb-8" },
              [
                { id: 'whatsapp', label: 'WhatsApp', color: 'bg-green-500', comingSoon: true },
                { id: 'instagram', label: 'Instagram', color: 'bg-pink-500', comingSoon: false },
                { id: 'email', label: 'Email', color: 'bg-red-500', comingSoon: true },
                { id: 'messenger', label: 'Messenger', color: 'bg-blue-500', comingSoon: true }
              ].map((item) =>
                React.createElement(StatCard, {
                  key: item.id,
                  ...item,
                  isActive: botToggles[item.id],
                  isLoading: isConfigLoading || loadingToggles,
                  onToggle: toggleBot
                })
              )
            ),
            React.createElement('div', { className: "flex-1 flex flex-col items-center justify-center text-gray-400 dark:text-gray-500 border-2 border-dashed border-gray-200 dark:border-gray-700 rounded-2xl bg-gray-50/50 dark:bg-gray-800/30 p-6 text-center" },
              React.createElement(LayoutDashboard, { size: 48, className: "mb-4 text-gray-300 dark:text-gray-600" }),
              React.createElement('p', { className: "text-sm font-medium" }, "Select a channel above to configure deployment parameters."),
              React.createElement('div', { className: "mt-4 flex gap-2 text-xs bg-gray-100 dark:bg-gray-800 px-3 py-1.5 rounded-full text-gray-500" },
                React.createElement(Wifi, { size: 14 }),
                React.createElement('span', null, `Connected to ${clientName || '...'}`)
              )
            )
          );

          if (isConfigLoading) {
             return React.createElement('div', { className: "flex h-screen items-center justify-center bg-gray-50 dark:bg-gray-900" },
                React.createElement('div', { className: "flex flex-col items-center" },
                    React.createElement(Loader2, { size: 48, className: "animate-spin text-indigo-600 mb-4" }),
                    React.createElement('h2', { className: "text-xl font-bold text-gray-800 dark:text-gray-200" }, "Authenticating..."),
                    React.createElement('p', { className: "text-gray-500 text-sm mt-2" }, "Verifying session and loading profile.")
                )
             );
          }

          return React.createElement('div', { className: "flex h-screen bg-gray-50 dark:bg-gray-900 font-sans overflow-hidden" },
            isMobileSidebarOpen && React.createElement('div', {
                className: "fixed inset-0 bg-black/50 z-40 md:hidden backdrop-blur-sm transition-opacity",
                onClick: handleBackdropClick
            }),
            React.createElement('aside', {
              className: `fixed md:relative inset-y-0 left-0 z-50 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 flex flex-col transition-all duration-300 ease-in-out
                    ${isMobileSidebarOpen ? 'translate-x-0 w-64' : '-translate-x-full md:translate-x-0'}
                    ${isSidebarOpen ? 'md:w-64' : 'md:w-20'}`
            },
              React.createElement('div', { className: "p-6 flex items-center justify-between h-20" },
                 React.createElement('div', { className: "flex items-center gap-3" },
                     React.createElement('div', { className: "w-9 h-9 bg-indigo-600 rounded-xl flex items-center justify-center text-white font-bold shadow-lg shadow-indigo-500/30 flex-shrink-0" },
                       React.createElement(PillarIcon, { size: 20 })
                     ),
                     (isSidebarOpen || isMobileSidebarOpen) && React.createElement('span', { className: "font-bold text-xl tracking-tight text-gray-800 dark:text-white truncate" }, "ATLAS")
                 ),
                 React.createElement('button', { onClick: () => setMobileSidebarOpen(false), className: "md:hidden p-2 text-gray-500 hover:bg-gray-100 rounded-lg" },
                     React.createElement(X, { size: 20 })
                 )
              ),
              React.createElement('div', { className: "px-3 py-2 flex-1 overflow-y-auto" },
                  React.createElement('nav', { className: "space-y-1" },
                      React.createElement(SidebarItem, { id: "dashboard", icon: LayoutDashboard, label: "Dashboard" }),
                      React.createElement(SidebarItem, { id: "audience", icon: Users, label: "Audience" }),
                      React.createElement(SidebarItem, { id: "analytics", icon: BarChart3, label: "Analytics" })
                  )
              ),
              React.createElement('div', { className: "p-3 border-t border-gray-100 dark:border-gray-700" },
                React.createElement(SidebarItem, { id: "settings", icon: Settings, label: "Settings" }),
                React.createElement('button', {
                  onClick: () => setSidebarOpen(!isSidebarOpen),
                  className: "w-full mt-2 hidden md:flex items-center justify-center p-2 text-gray-400 hover:text-gray-600 dark:text-gray-500 dark:hover:text-gray-300 transition-colors min-h-[44px]"
                },
                  isSidebarOpen ? React.createElement(ToggleLeft, { size: 24 }) : React.createElement(ToggleRight, { size: 24 })
                )
              )
            ),
            React.createElement('main', { className: "flex-1 flex flex-col overflow-hidden relative w-full" },
              React.createElement('header', { className: "min-h-20 bg-white/80 dark:bg-gray-800/80 backdrop-blur-md border-b border-gray-200 dark:border-gray-700 flex flex-col md:flex-row justify-between items-center px-4 md:px-8 py-3 md:py-0 z-10 gap-3 md:gap-0" },
                React.createElement('div', { className: "w-full md:w-auto flex items-center justify-between md:justify-start gap-4" },
                    React.createElement('button', {
                      onClick: () => setMobileSidebarOpen(true),
                      className: "md:hidden p-2 -ml-2 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg"
                    },
                        React.createElement(Menu, { size: 24 })
                    ),
                    React.createElement('div', { className: "flex-1 md:flex-none" },
                        React.createElement('h1', { className: "text-xl md:text-2xl font-bold text-gray-800 dark:text-white capitalize tracking-tight" },
                          activeTab
                        ),
                        React.createElement('div', { className: "flex items-center gap-2 text-xs text-gray-500 dark:text-gray-400 mt-0.5" },
                          clientName && React.createElement('span', { className: "flex items-center gap-1 bg-indigo-50 dark:bg-indigo-900/20 text-indigo-600 dark:text-indigo-400 px-2 py-0.5 rounded text-[10px] font-semibold uppercase tracking-wider" },
                              React.createElement(Database, { size: 10 }),
                              clientName
                          ),
                          React.createElement('span', { className: "hidden xs:inline" }, activeTab === 'dashboard' ? 'Overview & Status' : 'Metrics')
                        )
                    )
                ),
                React.createElement('div', { className: "w-full md:w-auto flex items-center justify-end gap-3 md:gap-5" },
                  !needsSetup && trialDays !== null && React.createElement('div', { className: `flex items-center gap-1.5 md:gap-2 px-2 md:px-3 py-1 md:py-1.5 rounded-full text-[10px] md:text-xs font-semibold border transition-all whitespace-nowrap ${
                            trialDays <= 3 
                                ? 'bg-red-50 dark:bg-red-900/20 text-red-700 dark:text-red-400 border-red-200 dark:border-red-800' 
                                : 'bg-blue-50 dark:bg-blue-900/20 text-blue-700 dark:text-blue-400 border-blue-200 dark:border-blue-800'
                        }` },
                            React.createElement(Clock, { size: 12, className: "md:w-3.5 md:h-3.5" }),
                            `${trialDays} Days`
                        ),
                  React.createElement('div', { className: "h-6 w-px bg-gray-200 dark:bg-gray-700 mx-1 hidden md:block" }),
                  React.createElement('div', { className: "flex items-center gap-2" },
                      React.createElement('button', {
                        onClick: toggleTheme,
                        className: "p-2 text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full transition-colors min-w-[40px] min-h-[40px] flex items-center justify-center",
                        title: "Toggle Theme"
                      },
                        isDarkMode ? React.createElement(Sun, { size: 20, className: "text-yellow-400" }) : React.createElement(Moon, { size: 20 })
                      ),
                      React.createElement('button', {
                          onClick: handleLogout,
                          className: "flex items-center gap-2 px-3 py-2 text-sm text-gray-500 hover:text-red-600 dark:text-gray-400 dark:hover:text-red-400 transition-colors rounded-lg hover:bg-red-50 dark:hover:bg-red-900/20 min-h-[40px]",
                          title: "Logout"
                      },
                          React.createElement(LogOut, { size: 20 }),
                          React.createElement('span', { className: "hidden md:inline font-medium" }, "Logout")
                      )
                  )
                )
              ),
              React.createElement('div', { className: "flex-1 overflow-y-auto p-4 md:p-8 bg-gray-50 dark:bg-gray-900 scroll-smooth" },
                React.createElement('div', { className: "max-w-7xl mx-auto w-full" },
                  needsSetup && React.createElement('div', { className: "mx-auto max-w-7xl mb-6 p-4 bg-amber-50 border border-amber-200 rounded-xl flex flex-col md:flex-row items-start md:items-center justify-between gap-4 shadow-sm dark:bg-amber-900/20 dark:border-amber-800" },
                      React.createElement('div', { className: "flex items-start md:items-center gap-4" },
                          React.createElement('div', { className: "p-2 bg-amber-100 dark:bg-amber-800/50 rounded-lg text-amber-600 dark:text-amber-400 flex-shrink-0" },
                              React.createElement(AlertCircle, { size: 24 })
                          ),
                          React.createElement('div', null,
                              React.createElement('h3', { className: "text-lg font-bold text-gray-800 dark:text-white" }, "Account Setup Required"),
                              React.createElement('p', { className: "text-sm text-gray-600 dark:text-gray-300 mt-1 md:mt-0" }, "Your account configuration is incomplete. Please finish setting up your profile.")
                          )
                      ),
                      React.createElement('button', {
                          onClick: () => window.location.href = 'DEP_SYSTEME.html',
                          className: "w-full md:w-auto px-6 py-3 md:py-2.5 bg-amber-500 hover:bg-amber-600 text-white font-bold rounded-lg shadow-md hover:shadow-lg transition-all flex items-center justify-center gap-2 min-h-[44px]"
                      },
                          "SET UP ACCOUNT",
                          React.createElement(ArrowRight, { size: 18 })
                      )
                  ),
                  activeTab === 'dashboard' && renderDashboard(),
                  activeTab === 'analytics' && React.createElement(AnalyticsView, { tableConfig: clientConfig }),
                  ['settings'].includes(activeTab) && React.createElement('div', { className: "flex flex-col items-center justify-center h-[60vh] text-gray-400 dark:text-gray-500 px-4 text-center" },
                      React.createElement(RefreshCw, { size: 48, className: "mb-4 text-gray-300 dark:text-gray-600" }),
                      React.createElement('h3', { className: "text-lg font-medium text-gray-500 dark:text-gray-400" }, "Settings Module"),
                      React.createElement('p', { className: "text-sm mt-2" }, `Configuration options for ${clientName} will appear here.`)
                  )
                )
              ),
              toast && React.createElement(Toast, {
                message: toast.message,
                type: toast.type,
                onClose: () => setToast(null)
              })
            )
          );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(React.createElement(AtlasDashboard));
    </script>
</body>
</html>
